# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
    # paths-ignore: ['README.md', 'src/ios/**', 'src/test/**', '.github/**']
    paths:
      - 'src/robinhood_options_mobile/lib/**'
      - 'src/robinhood_options_mobile/android/**'
      - 'src/robinhood_options_mobile/ios/**'
      - 'src/robinhood_options_mobile/pubspec.yaml'
  pull_request:
    # branches: [ main ]

permissions:
  contents: write

jobs:
  analyze_and_test:
    name: Analyze and Test 
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: src/robinhood_options_mobile
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify code formatting
        # Consider passing '--fatal-infos' for slightly stricter analysis.
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: true

      - name: Analyze project source
        run: flutter analyze
        continue-on-error: true

      # Your project will need to have tests in test/ and a dependency on
      # package:test for this step to succeed. Note that Flutter projects will
      # want to change this to 'flutter test'.
      - name: Run tests
        run: flutter test
        continue-on-error: true

  check_version:
    name: Check Version Change
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      tag_name: ${{ steps.check.outputs.tag_name }}
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Check and Create Tag
        id: check
        working-directory: src/robinhood_options_mobile
        run: |
          VERSION=$(grep 'version: ' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          TAG_NAME="v$VERSION"
          
          echo "Checking tag: $TAG_NAME"
          
          # Extract release notes from ROADMAP.md
          ROADMAP_PATH="ROADMAP.md"
          # In workflow default working directory is src/robinhood_options_mobile
          # But ROADMAP.md is at root. We're currently in src/robinhood_options_mobile because of defaults.run
          # So we need to go up two levels
          ROADMAP_PATH="../../ROADMAP.md"
          
          if [ -f "$ROADMAP_PATH" ]; then
            # Extract content between the current version header and the next version header
            # Version header format: ### v0.31.4 ...
            # We want to match "### v0.31.4" where 0.31.4 is VERSION
            
            # Escape dots for regex
            ESCAPED_VERSION=$(echo $VERSION | sed 's/\./\\./g')
            
            # awk pattern:
            # Start: Line starts with "### v" followed by VERSION
            # End: Next line starting with "### v"
            
            RELEASE_NOTES=$(awk "/^### v$ESCAPED_VERSION/{flag=1;next}/^### v/{flag=0}flag" $ROADMAP_PATH)
            
            # If empty, default to something
            if [ -z "$RELEASE_NOTES" ]; then
              RELEASE_NOTES="Release $TAG_NAME"
              echo "Warning: No release notes found in ROADMAP.md for v$VERSION"
            fi
            
            echo "Extracted Release Notes:"
            echo "$RELEASE_NOTES"
            
            # Output multiline string
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
             echo "ROADMAP.md not found at $ROADMAP_PATH"
             echo "release_notes=Release $TAG_NAME" >> $GITHUB_OUTPUT
          fi
          
          # Check if tag exists on remote
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists."
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG_NAME does not exist. Will be created after successful builds."
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          fi

  build_android:
    name: Build Android
    needs: [analyze_and_test, check_version]
    if: needs.check_version.outputs.new_version == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: src/robinhood_options_mobile
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable # or: beta, master (or main)
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # - name: Build web
      #   run: flutter build web --web-renderer html

      # Uncomment the following steps to build Android

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android Signing
        run: |
          echo "${{ secrets.ANDROID_KEY_PROPERTIES }}" > android/key.properties
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Build Android APK
        run: flutter build apk --release
        continue-on-error: false

      - name: Upload Android APK Build Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name
          name: release-apk
          # A file, directory or wildcard pattern that describes what to upload
          path: src/robinhood_options_mobile/build/app/outputs/flutter-apk/app-release.apk
          # The desired behavior if no files are found using the provided path.
        continue-on-error: false



      - name: Build Android AppBundle
        run: flutter build appbundle --release
        continue-on-error: false

      - name: Upload App Bundle (.aab) Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: src/robinhood_options_mobile/build/app/outputs/bundle/release/app-release.aab
        continue-on-error: false

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1.0.19
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_UPLOAD_SERVICE_ACCOUNT_JSON }}
          packageName: com.cidevelop.robinhood_options_mobile
          releaseFiles: src/robinhood_options_mobile/build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: draft
        continue-on-error: true

  build_ios:
    name: Build iOS
    needs: [analyze_and_test, check_version]
    if: needs.check_version.outputs.new_version == 'true'
    runs-on: macos-latest # Uses latest available macOS runner
    timeout-minutes: 45
    defaults:
      run:
        working-directory: src/robinhood_options_mobile
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: src/robinhood_options_mobile/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('src/robinhood_options_mobile/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Setup iOS Signing
        run: |
          # Import Certificate
          echo "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          
          # Import Provisioning Profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/main_app.mobileprovision
          if [ -n "${{ secrets.IOS_WIDGET_PROVISIONING_PROFILE_BASE64 }}" ]; then
            echo "${{ secrets.IOS_WIDGET_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/widget.mobileprovision
          fi
          
          # Create and configure Keychain
          security create-keychain -p "" build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          
          # Import Certificate to Keychain
          security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          # Create ExportOptions.plist
          echo "${{ secrets.IOS_EXPORT_OPTIONS_PLIST }}" > ios/ExportOptions.plist

      - name: Build iOS IPA
        # run: flutter build ipa --release --export-options-plist=ios/ExportOptions.plist
        run: |
          # Extract Profile UUIDs
          MAIN_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/main_app.mobileprovision))
          echo "Using Main Profile UUID: $MAIN_UUID"
          
          WIDGET_UUID=""
          if [ -f ~/Library/MobileDevice/Provisioning\ Profiles/widget.mobileprovision ]; then
            WIDGET_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/widget.mobileprovision))
            echo "Using Widget Profile UUID: $WIDGET_UUID"
          fi
          
          # Force Manual Signing and set Profile match
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*";/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*;/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' "s/CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"iPhone Developer\";/CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"iPhone Distribution\";/g" ios/Runner.xcodeproj/project.pbxproj

          # Update Main App target(s)
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com.cidevelop.robinhoodOptionsMobile;/PRODUCT_BUNDLE_IDENTIFIER = com.cidevelop.robinhoodOptionsMobile; PROVISIONING_PROFILE = $MAIN_UUID;/g" ios/Runner.xcodeproj/project.pbxproj
          
          # Update Widget target(s) if applicable
          if [ -n "$WIDGET_UUID" ]; then
            sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = com.cidevelop.robinhoodOptionsMobile.PortfolioWidget;/PRODUCT_BUNDLE_IDENTIFIER = com.cidevelop.robinhoodOptionsMobile.PortfolioWidget; PROVISIONING_PROFILE = $WIDGET_UUID;/g" ios/Runner.xcodeproj/project.pbxproj
          fi
          
          # Update ExportOptions.plist with the profile(s)
          /usr/libexec/PlistBuddy -c "Delete :provisioningProfiles" ios/ExportOptions.plist || true
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" ios/ExportOptions.plist
          /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:com.cidevelop.robinhoodOptionsMobile string $MAIN_UUID" ios/ExportOptions.plist
          if [ -n "$WIDGET_UUID" ]; then
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:com.cidevelop.robinhoodOptionsMobile.PortfolioWidget string $WIDGET_UUID" ios/ExportOptions.plist
          fi
          
          /usr/libexec/PlistBuddy -c "Delete :signingStyle" ios/ExportOptions.plist || true
          /usr/libexec/PlistBuddy -c "Add :signingStyle string manual" ios/ExportOptions.plist
          
          flutter build ipa --release --export-options-plist=ios/ExportOptions.plist

      - name: Upload iOS IPA Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-ipa
          path: src/robinhood_options_mobile/build/ios/ipa/*.ipa
          # path: build/ios/ipa/*.ipa

      - name: Upload to App Store
        run: |
          # Check if API Key secrets are available
          if [ -n "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" ] && [ -n "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" ]; then
            echo "Using API Key for authentication"
            
            # Setup Private Key file
            mkdir -p ~/.appstoreconnect/private_keys
            echo "${{ secrets.APP_STORE_CONNECT_API_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
            
            xcrun altool --upload-app --type ios -f build/ios/ipa/*.ipa --apiKey "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" --apiIssuer "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"
          else
            echo "Using Username/Password for authentication"
            xcrun altool --upload-app --type ios -f build/ios/ipa/*.ipa --username "${{ secrets.APP_STORE_CONNECT_USERNAME }}" --password "${{ secrets.APP_STORE_CONNECT_PASSWORD }}"
            # --verbose
          fi



  create_release:
    name: Create GitHub Release
    needs: [check_version, build_android, build_ios]
    if: needs.check_version.outputs.new_version == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Create Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ needs.check_version.outputs.tag_name }}
          git push origin ${{ needs.check_version.outputs.tag_name }}

      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: release-artifacts/android/

      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-ipa
          path: release-artifacts/ios/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check_version.outputs.tag_name }}
          body: ${{ needs.check_version.outputs.release_notes }}
          generate_release_notes: true
          files: |
            release-artifacts/android/*.apk
            release-artifacts/ios/*.ipa

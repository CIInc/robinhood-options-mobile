name: Release (Android, iOS)

on:
  workflow_dispatch: # Allows manual triggering
    inputs:
      release_tag:
        description: 'Release tag for the draft'
        required: true
        type: string
  release:
    types: [created, published]
  push:
    tags:
      - "v*.*.*"

jobs:
  release_meta:
    name: Resolve/Create Release metadata
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.set_url.outputs.upload_url }}
    steps:
      - name: Create draft release (manual)
        if: github.event_name == 'workflow_dispatch'
        id: create_release_manual
        # uses: actions/create-release@v1
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          # release_name: ${{ github.event.inputs.release_tag }}
          draft: true
          generate_release_notes: true

      - name: Create draft release (tag push)
        if: github.event_name == 'push'
        id: create_release_push
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: true

      - name: Set upload_url output
        id: set_url
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "upload_url=${{ github.event.release.upload_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "upload_url=${{ steps.create_release_manual.outputs.upload_url }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "upload_url=${{ steps.create_release_push.outputs.upload_url }}" >> $GITHUB_OUTPUT
          fi

  build_android:
    runs-on: ubuntu-latest
    needs: release_meta
    # TODO: Reintroduce macos-latest once we resolve the IPA build failure below. 
    #runs-on: macos-latest

    defaults:
      run:
        working-directory: src/robinhood_options_mobile
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu' # Default from v1. See https://github.com/actions/setup-java?tab=readme-ov-file#supported-distributions
          java-version: '17'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable # or: beta, master (or main)

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Android Signing
        run: |
          echo "${{ secrets.ANDROID_KEY_PROPERTIES }}" > android/key.properties
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Build Android APK
        run: flutter build apk --release

      # Create draft release when manually triggered with workflow_dispatch
      - name: Create draft release (manual runs)
        if: github.event_name == 'workflow_dispatch'
        id: create_release_manual
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          release_name: ${{ github.event.inputs.release_tag }}
          draft: true

      # Resolve upload_url when triggered by a release event
      - name: Get release upload URL (release event)
        if: github.event_name == 'release'
        id: get_release_event
        run: echo "upload_url=${{ github.event.release.upload_url }}" >> $GITHUB_OUTPUT

      # Create draft release for tag push if one doesn't exist
      - name: Create draft release (tag push)
        if: github.event_name == 'push'
        id: create_release_push
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: true

      - name: Upload Android APK Build Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifact name
          name: release-apk
          # A file, directory or wildcard pattern that describes what to upload
          path: src/robinhood_options_mobile/build/app/outputs/flutter-apk/app-release.apk
          # The desired behavior if no files are found using the provided path.

      # steps for building assets
      #- run: echo "REPLACE ME!" > assets.txt

      - name: Upload Android APK to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ needs.release_meta.outputs.upload_url }}
          asset_path: src/robinhood_options_mobile/build/app/outputs/flutter-apk/app-release.apk
          asset_name: app-release.apk
          asset_content_type: application/vnd.android.package-archive

  build_ios:
    runs-on: macos-latest
    needs: release_meta
    defaults:
      run:
        working-directory: src/robinhood_options_mobile
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Java (for some Flutter tooling)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          pod --version
        working-directory: src/robinhood_options_mobile/ios

      - name: Install dependencies
        run: flutter pub get

      - name: Pod install
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS IPA (no codesign)
        run: flutter build ipa --release --no-codesign

      - name: Upload iOS IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-ipa
          path: src/robinhood_options_mobile/build/ios/ipa/*.ipa

      - name: Upload iOS IPA to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ needs.release_meta.outputs.upload_url }}
          asset_path: src/robinhood_options_mobile/build/ios/ipa/*.ipa
          asset_name: app-release.ipa
          asset_content_type: application/octet-stream

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /user/{uid} {
      allow read, create: if request.auth.uid != null;
      allow update: if request.auth.uid == uid || request.auth.token.role == 'admin';
      allow delete: if request.auth.token.role == 'admin';
      // Trade signal notification settings are stored in the user document
      // and are covered by the parent rules above
      match /instrumentPosition/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /instrumentOrder/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /optionPosition/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /optionOrder/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /optionEvent/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /forexPosition/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /dividend/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /interest/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /automated_buy_trades/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.token.role == 'admin';
      }
      match /pending_orders/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.uid == uid || request.auth.token.role == 'admin';
      }
      match /backtest_history/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.uid == uid || request.auth.token.role == 'admin';
      }
      match /backtest_templates/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.uid == uid || request.auth.token.role == 'admin';
      }
      match /coaching_sessions/{id} {
        allow read : if request.auth.uid != null;
        allow create, update: if request.auth.uid == uid || request.auth.token.role == 'admin';
        allow delete: if request.auth.uid == uid || request.auth.token.role == 'admin';
      }
      match /signal_notifications/{id} {
        allow read: if request.auth.uid == uid;
        allow update: if request.auth.uid == uid; // for marking as read
        allow create: if false; // server-side only
        allow delete: if request.auth.uid == uid;
      }
    }
    match /instrument/{instrumentid} {
      allow read: if true;
      allow create, update: if request.auth.uid != null;
      allow delete: if request.auth.token.role == 'admin';
    }
    
    match /agentic_trading/{doc} {
      allow read: if true;
      allow create, update: if request.auth.uid != null;
      allow delete: if request.auth.token.role == 'admin';
    }

    match /yahoo_options_results/{symbol} {
      allow read: if true;
      allow create, update: if request.auth.uid != null;

      match /expirations/{expirationId} {
        allow read: if true;
        allow create, update: if request.auth.uid != null;
      }
    }

    match /yahoo_quote_summaries/{symbol} {
      allow read: if true;
      allow create, update: if request.auth.uid != null;
    }

    match /investor_groups/{groupId} {
      // Anyone can read public groups, members can read private groups, invited users can read
      allow read: if resource.data.isPrivate == false || 
        request.auth.uid != null && (
          request.auth.uid in resource.data.get('members', []) ||
          request.auth.uid in resource.data.get('pendingInvitations', [])
        );
      // Authenticated users can create groups
      allow create: if request.auth.uid != null;
      // Only group admins or creator can update (for invitations and member management)
      // Users with pending invitations can update to accept/decline
      allow update: if request.auth.uid != null && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.uid in resource.data.get('admins', []) ||
        request.auth.uid in resource.data.get('pendingInvitations', [])
      );
      allow delete: if request.auth.uid != null && (
        request.auth.uid == resource.data.createdBy ||
        request.auth.token.role == 'admin'
      );

      match /messages/{messageId} {
        allow read: if get(/databases/$(database)/documents/investor_groups/$(groupId)).data.isPrivate == false || 
          (request.auth.uid != null && 
          request.auth.uid in get(/databases/$(database)/documents/investor_groups/$(groupId)).data.members);
        allow create: if request.auth.uid != null && 
          request.auth.uid in get(/databases/$(database)/documents/investor_groups/$(groupId)).data.members &&
          request.resource.data.senderId == request.auth.uid;
        allow update, delete: if request.auth.uid != null && (
          resource.data.senderId == request.auth.uid ||
          request.auth.uid == get(/databases/$(database)/documents/investor_groups/$(groupId)).data.createdBy ||
          request.auth.uid in get(/databases/$(database)/documents/investor_groups/$(groupId)).data.admins
        );
      }
    }

    match /copy_trades/{tradeId} {
      // Users can read their own copy trades (as source or target)
      allow read: if request.auth.uid != null && (
        // request.auth.uid == resource.data.sourceUserId ||
        request.auth.uid == resource.data.targetUserId
      );
      // Only the system (backend functions) can create copy trades
      // In practice, this is enforced by the functions
      allow create: if false;
      // Target users can update to mark as executed/rejected
      allow update: if request.auth.uid != null && 
        request.auth.uid == resource.data.targetUserId;
      // Admins can delete
      allow delete: if request.auth.token.role == 'admin';
    }

    match /order_templates/{templateId} {
      allow read: if request.auth.uid != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth.uid != null && resource.data.userId == request.auth.uid;
    }

    //match /{document=**} {
    //  allow read, write: if false;
    //  //allow read, write: if
    //  //    request.time < timestamp.date(2025, 3, 6);
    //}
  }
}